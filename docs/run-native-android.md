# How to Run the App

This guide walks you through building and running the Beyond Binary Inclusive Emergency Response app on your device.

---

## Prerequisites

| Requirement | Details |
|---|---|
| **Android Studio** | Latest stable (Ladybug or newer) |
| **JDK** | 17+ (bundled with Android Studio) |
| **Android SDK** | API 34 (compileSdk / targetSdk) |
| **Device** | Physical Android device (API 26+) or emulator |
| **OpenAI Key** | Optional -- for AI-powered bystander cards |

> **Tip**: A physical device is strongly recommended. Fall detection, SMS dispatch, and voice recognition require real sensors, a SIM card, and a microphone.

---

## Step-by-Step

### 1. Clone the Repository

```bash
git clone https://github.com/your-org/beyond-binary-hack.git
cd beyond-binary-hack
```

### 2. Configure OpenAI API Key (Optional)

If you want AI-generated bystander help cards:

1. Open `app/gradle.properties`
2. Replace the placeholder:
   ```properties
   OPENAI_API_KEY=sk-proj-your-actual-key-here
   ```
3. If you skip this step, the app uses hardcoded fallback cards instead.

### 3. Open in Android Studio

1. Launch Android Studio.
2. **File > Open** > navigate to the `app/` folder inside the cloned repo.
   - Important: Open the `app/` folder, not the repo root. This is where `settings.gradle.kts` lives.
3. Wait for Gradle sync to complete (may take 1-2 minutes on first sync).

### 4. Connect Your Device

**Physical device (recommended):**
1. Enable **Developer Options** on your phone (Settings > About > tap Build Number 7 times).
2. Enable **USB Debugging** in Developer Options.
3. Connect via USB. Accept the debugging prompt on your phone.

**Emulator:**
1. Open **Device Manager** in Android Studio.
2. Create a new AVD with API 26 or higher.
3. Start the emulator.

### 5. Build and Run

1. Select the **app** run configuration in the toolbar.
2. Select your connected device from the device dropdown.
3. Click **Run** (green play button) or press `Shift+F10`.
4. The app will build, install, and launch on your device.

### 6. First Launch: Onboarding

On first launch, the onboarding wizard appears:

1. **Name & Address** -- Enter your name and home address.
2. **Unit Number** -- Your flat/unit number (for SCDF SMS format).
3. **Caregiver Contact** -- Primary caregiver phone number.
4. **Secondary Contact** -- Optional backup contact.
5. **Medical Info** -- Conditions, allergies, blood type, medications.
6. **Communication Mode** -- Choose Touch, Voice, or Both.

### 7. Grant Permissions

The app will request these permissions at runtime:

- **Location** (Fine) -- for GPS coordinates in SMS.
- **SMS** -- to send emergency messages.
- **Microphone** -- for voice commands (STT).
- **Activity Recognition** -- required for health foreground service.
- **Notifications** (Android 13+) -- for monitoring status notification.

Grant all permissions for full functionality.

---

## Testing the Emergency Flow

### Option A: Manual Trigger

Tap the large red **"Emergency Help"** button on the main screen.

### Option B: Volume Key Trigger

Press any **volume key** to trigger the emergency countdown.

### Option C: ADB Broadcast (Simulated Fall)

```bash
adb shell am broadcast -a com.example.emergencyresponse.ACTION_FALL_DETECTED --es trigger_type fall -p com.example.emergencyresponse
```

### Option D: Actual Fall Detection

Drop your phone onto a soft surface (e.g., bed). The fall detection is tuned for testing sensitivity. The sequence:
1. Free-fall detected (phone in the air)
2. Impact detected (phone hits surface)
3. Stillness verified (phone stops moving)
4. Emergency countdown begins

### Expected Flow

1. **Countdown screen** appears (10 seconds).
2. Say **"help"** or tap the **Help** button to escalate.
3. Choose a service: **Fire**, **Ambulance**, or **Police**.
4. Choose what's happening (context options vary by service).
5. Confirm your **location** on the map.
6. SMS is dispatched (mocked by default -- see `AppConfig.kt`).

---

## Testing Bystander Cards

1. On the idle screen, tap the blue **"Bystander Help Cards"** button.
2. A loading spinner appears while cards are generated by OpenAI.
3. 6 cards appear in a colour-coded grid.
4. Tap any card to see the full message.
5. Use **language buttons** (English / Malay / 中文 / தமிழ்) to regenerate in another language.
6. Tap **"Speak Message"** to hear the card read aloud.

---

## Build from Command Line

From the `app/` directory:

```bash
# Linux/macOS
./gradlew assembleDebug
./gradlew installDebug

# Windows PowerShell
.\gradlew.bat assembleDebug
.\gradlew.bat installDebug
```

---

## Common Issues

| Issue | Solution |
|---|---|
| Gradle sync fails | Make sure you opened the `app/` folder, not the repo root |
| R.jar file lock (Windows) | Close Android Studio, delete `app/build/`, reopen |
| "OPENAI_API_KEY is empty" in Logcat | Add your key to `app/gradle.properties` and rebuild |
| Voice commands not working | Grant microphone permission; set communication mode to Voice/Both |
| Location not resolving | Enable GPS on your device; the app will prompt you if it's off |
| SMS not sending | In mock mode (default), SCDF SMS is logged only. Set `MOCK_DISPATCH_MODE = false` for live |
| Fall detection not triggering | Check that the foreground service notification is visible; whitelist app from battery optimization |
