# Beyond Binary Hack - Inclusive Emergency Response App

A native Android (Kotlin) emergency response application designed for motor-impaired and vulnerable users in Singapore. The app detects falls via accelerometer sensors, guides the user through a fully accessible emergency flow using voice, touch, and haptic feedback, dispatches SMS alerts to SCDF (Singapore Civil Defence Force) and caregiver contacts, and provides AI-generated bystander assistance cards.

---

## Table of Contents

- [Features](#features)
- [Screenshots & Flow](#screenshots--flow)
- [Project Structure](#project-structure)
- [Architecture](#architecture)
- [How to Run](#how-to-run)
- [OpenAI API Key Setup](#openai-api-key-setup)
- [Dispatch Mode Configuration](#dispatch-mode-configuration)
- [Permissions](#permissions)
- [Accessibility](#accessibility)
- [SMS Format (SCDF Guidelines)](#sms-format-scdf-guidelines)
- [Tech Stack](#tech-stack)
- [Testing](#testing)
- [Troubleshooting](#troubleshooting)
- [Documentation](#documentation)

---

## Features

### Core Emergency Flow
- **Fall & Tremor Detection** -- Background foreground service monitors the accelerometer for free-fall + impact sequences and sustained severe tremor patterns.
- **Direct Screen Pop-up** -- When a fall/tremor is detected, the app launches the countdown screen directly (not just a notification), even from the background or lock screen.
- **Multi-step Emergency Wizard**:
  1. **Drop Countdown** -- 10-second countdown after detection; user can say "help" or "okay" to escalate/cancel. Voice input is active immediately.
  2. **Service Selection** -- Choose Fire, Ambulance, or Police with large emoji buttons or voice.
  3. **Context Selection** -- Describe what's happening (e.g. Fall, Chest Pain, Bleeding, My Unit on Fire).
  4. **Location Confirmation** -- GPS auto-resolve with reverse geocoding; interactive Google Maps WebView for visual confirmation.
  5. **Dispatch** -- Sends formatted SMS to SCDF 70995 and caregiver/secondary contacts with Google Maps link.

### Bystander Assistance (AI-Powered)
- **AI-Generated Help Cards** -- Uses OpenAI GPT-4o-mini to generate 6 personalised bystander help cards based on the user's medical profile (conditions, allergies, blood type, medications).
- **Multi-Language Support** -- Cards can be regenerated in English, Malay, Chinese, and Tamil via language toggle buttons.
- **Text-to-Speech on Cards** -- Each card has a "Speak Message" button with locale-appropriate TTS (adjusted pitch/rate for noisy environments).
- **Offline Fallback** -- If OpenAI is unavailable or the API key is not configured, 6 hardcoded fallback cards are shown in all 4 languages.
- **Loading State** -- Cards screen shows a spinner while generating, then displays results in a high-contrast colour-coded grid.

### Medical Profile & Card
- **User Onboarding** -- Multi-step wizard collects name, address, unit number, caregiver contacts, medical conditions, allergies, blood type, medications, and communication preference.
- **Medical Card View** -- Dedicated screen displaying all medical info in large readable text with a share button.
- **Settings** -- Edit profile data and view medical card at any time.

### Accessibility Features
- **5 Interaction Modalities** -- Accelerometer (sensor), touch, voice input (STT), voice output (TTS), and haptic vibration.
- **Shout for Help** -- One-tap button that plays a loud, repeating "HELP!" message at max volume using a dedicated TTS engine.
- **TTS Echo Filtering** -- Prevents the microphone from recognising the app's own TTS output as voice commands.
- **Adaptive Communication** -- Users choose Touch, Voice, or Both during onboarding; the app respects this at runtime.

### System Integration
- **Boot Startup** -- Fall detection service auto-starts on device boot.
- **OEM Battery Guidance** -- Detects manufacturer and logs specific instructions for disabling aggressive background killers.
- **Volume Key Trigger** -- Press volume keys as an alternative emergency trigger (no touch screen needed).

---

## Screenshots & Flow

```
┌─────────────┐    ┌──────────────┐    ┌───────────────┐    ┌──────────────────┐    ┌───────────────────┐    ┌──────────────────┐
│    IDLE      │───>│ DROP_COUNTDOWN│───>│SERVICE_SELECTION│──>│CONTEXT_SELECTION │───>│ LOCATION_CONFIRM  │───>│ DISPATCH_ACTIVE  │
│              │    │  (10 sec)    │    │ Fire/Ambu/Police│   │ What happened?   │    │ GPS + Map + Addr  │    │ SMS sent to SCDF │
│ [Emergency]  │    │ Say "help"   │    │ Voice or touch │   │ Voice or touch   │    │ Confirm & Dispatch│    │ + caregiver      │
│ [Settings]   │    │ Say "okay"   │    │                │   │                  │    │                   │    │                  │
│ [Bystander]  │    │              │    │                │   │                  │    │                   │    │ [Cancel] [Medical]│
└─────────────┘    └──────────────┘    └───────────────┘    └──────────────────┘    └───────────────────┘    └──────────────────┘
      ^                                                                                                              |
      |______________________________________________________________________________________________ (cancel) ______|
```

---

## Project Structure

```
beyond-binary-hack/
├── README.md                        # This file
├── .gitignore
├── assets/                          # Logo and design resources
│   └── photo_*.png                  # App logo source image
├── docs/                            # Documentation
│   ├── ARCHITECTURE.md              # Architecture & design decisions
│   ├── run-native-android.md        # Step-by-step run guide
│   ├── testing-guide.md             # Testing guide for FallDetectionService
│   └── test-summary.md              # Test coverage summary
│
├── app/                             # Android project root (Gradle root)
│   ├── build.gradle.kts             # Build configuration
│   ├── settings.gradle.kts          # Gradle settings
│   ├── gradle.properties            # Project properties (OpenAI key placeholder)
│   ├── gradlew / gradlew.bat        # Gradle wrapper
│   │
│   └── src/main/
│       ├── AndroidManifest.xml
│       │
│       ├── java/com/example/emergencyresponse/
│       │   ├── model/                        # Data layer
│       │   │   ├── AppConfig.kt              # Feature flags, defaults, SCDF number
│       │   │   ├── BystanderCard.kt          # Bystander card data class + BystanderLanguage enum
│       │   │   ├── EmergencyUiState.kt       # 6-state enum (IDLE → DISPATCH_ACTIVE)
│       │   │   ├── EmergencyUiModel.kt       # Immutable UI render snapshot
│       │   │   ├── EmergencyEvent.kt         # Accumulated dispatch payload
│       │   │   ├── UserProfile.kt            # User profile (name, medical, contacts)
│       │   │   ├── UserProfileRepository.kt  # SharedPreferences persistence
│       │   │   └── ServiceConfig.kt          # Emergency services registry (Fire/Ambulance/Police)
│       │   │
│       │   ├── service/                      # Background services
│       │   │   ├── FallDetectionService.kt   # Foreground service: accelerometer fall + tremor
│       │   │   └── BootReceiver.kt           # Starts service on device boot
│       │   │
│       │   ├── util/                         # Utility modules
│       │   │   ├── DispatchBridge.kt         # SMS formatting & dispatch (SCDF + caregiver)
│       │   │   ├── LocationHandler.kt        # GPS + reverse geocoding
│       │   │   ├── InteractionManager.kt     # TTS, STT, haptic feedback, echo filtering
│       │   │   └── OpenAiService.kt          # OpenAI GPT-4o-mini client for bystander cards
│       │   │
│       │   └── ui/                           # Screens
│       │       ├── MainActivity.kt           # Main emergency flow UI
│       │       ├── EmergencyViewModel.kt     # Centralized state machine
│       │       ├── OnboardingActivity.kt     # First-launch profile wizard
│       │       ├── SettingsActivity.kt       # Edit profile
│       │       ├── MedicalCardActivity.kt    # Medical card display + share
│       │       ├── BystanderCardsActivity.kt # Bystander help cards grid (AI-generated)
│       │       └── BystanderCardDetailActivity.kt # Full-screen card detail + TTS + language toggle
│       │
│       └── res/
│           ├── layout/
│           │   ├── activity_main.xml                # Main flow layout
│           │   ├── activity_onboarding.xml          # 5-step onboarding wizard
│           │   ├── activity_settings.xml            # Settings form
│           │   ├── activity_medical_card.xml         # Medical card view
│           │   ├── activity_bystander_cards.xml     # Bystander cards grid + loading spinner
│           │   ├── activity_bystander_card_detail.xml # Card detail + language toggle + speak button
│           │   └── item_bystander_card.xml          # Single card grid item
│           ├── drawable/
│           │   ├── bg_status_active.xml             # Monitoring status indicator
│           │   └── ic_app_logo.png                  # App icon
│           └── values/
│               ├── colors.xml                       # Material 3 colour palette
│               └── themes.xml                       # App theme
```

---

## Architecture

See [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md) for the full architecture and design document.

### State Machine

```
IDLE ──> DROP_COUNTDOWN ──> SERVICE_SELECTION ──> CONTEXT_SELECTION ──> LOCATION_CONFIRM ──> DISPATCH_ACTIVE
  ^                                                                                               |
  |_______________________________________________________________________________________________| (cancel)
```

### Key Design Decisions

- **MVVM** -- `EmergencyViewModel` owns all state; Activities observe via `StateFlow`.
- **Foreground Service** -- `FallDetectionService` runs with `foregroundServiceType="health"` for reliable background sensor monitoring.
- **Immediate STT for Countdown** -- During time-critical `DROP_COUNTDOWN`, speech recognition starts immediately in parallel with TTS.
- **TTS Echo Filtering** -- `InteractionManager` tracks last spoken prompt and filters STT results that overlap >60% with TTS output.
- **Direct Activity Launch** -- Fall detection attempts `startActivity()` directly; full-screen notification is the fallback for OEMs that block background launches.
- **Self-Contained Screens** -- `BystanderCardsActivity` handles its own OpenAI loading with a spinner, so cards appear as soon as the API responds.
- **Mock Dispatch** -- SMS to SCDF is mocked by default; caregiver SMS can be tested independently.

---

## How to Run

### Prerequisites

- **Android Studio** (latest stable, e.g. Ladybug or newer)
- **JDK 17+** (bundled with Android Studio)
- **Android SDK 34** (compileSdk / targetSdk)
- **Physical Android device** or emulator with **API 26+** (minSdk 26)
  - A physical device is strongly recommended for fall detection, SMS, and voice.

### Steps

1. **Clone the repository**:
   ```bash
   git clone https://github.com/your-org/beyond-binary-hack.git
   cd beyond-binary-hack
   ```

2. **Configure the OpenAI API key** (optional but recommended for AI bystander cards):
   ```
   # Edit app/gradle.properties and replace the placeholder:
   OPENAI_API_KEY=sk-your-actual-key-here
   ```
   See [OpenAI API Key Setup](#openai-api-key-setup) for details.

3. **Open in Android Studio**:
   - File > Open > select the `app/` folder (this is the Gradle root).
   - Wait for Gradle sync to complete.

4. **Connect a device or start an emulator**:
   - Enable USB debugging on your physical device, or
   - Create an AVD with API 26+ in Device Manager.

5. **Build and run**:
   - Select the `app` run configuration.
   - Click **Run** (green play button) or press `Shift+F10`.

6. **Grant permissions** when prompted:
   - Location (Fine), SMS, Activity Recognition, Microphone, Notifications (Android 13+).

7. **Complete onboarding** on first launch:
   - Enter your name, address, caregiver number, medical info, and communication preference.

8. **Test the emergency flow**:
   - Tap the large **"Emergency Help"** button, or
   - Press a **volume key**, or
   - Simulate a fall broadcast via ADB:
     ```bash
     adb shell am broadcast -a com.example.emergencyresponse.ACTION_FALL_DETECTED --es trigger_type fall -p com.example.emergencyresponse
     ```

---

## OpenAI API Key Setup

The Bystander Assistance feature uses **OpenAI GPT-4o-mini** to generate personalised help cards. This is optional -- the app works fully without it using hardcoded fallback cards.

1. Get an API key from [platform.openai.com](https://platform.openai.com/api-keys).
2. Open `app/gradle.properties`.
3. Replace the placeholder:
   ```properties
   OPENAI_API_KEY=sk-proj-your-actual-key
   ```
4. Rebuild the project. The key is injected into `BuildConfig.OPENAI_API_KEY` at compile time.

**Important**: Do **not** commit your real API key to version control. The committed `gradle.properties` contains a safe placeholder `<YOUR_API_KEY>`.

If no key is configured, the app gracefully falls back to 6 built-in bystander cards in all 4 languages.

---

## Dispatch Mode Configuration

In `AppConfig.kt` (`model/AppConfig.kt`):

| Flag | Default | Effect |
|---|---|---|
| `MOCK_DISPATCH_MODE` | `true` | When `true`, SCDF SMS is **not** sent (logged + shown in dialog). |
| `TEST_CAREGIVER_SMS` | `true` | When `true` (and mock mode on), sends **real** SMS to caregiver/secondary contact only. |

- **Fully live** (production): set `MOCK_DISPATCH_MODE = false`.
- **Fully mock** (no SMS at all): set `TEST_CAREGIVER_SMS = false`.

---

## Permissions

| Permission | Purpose |
|---|---|
| `ACCESS_FINE_LOCATION` | GPS for emergency location dispatch |
| `SEND_SMS` | Send emergency SMS to SCDF and contacts |
| `RECORD_AUDIO` | Voice command recognition (STT) |
| `CAMERA` | Reserved for future thumbs-up gesture detection |
| `FOREGROUND_SERVICE` | Background fall/tremor monitoring |
| `FOREGROUND_SERVICE_HEALTH` | Health-type foreground service (API 34+) |
| `ACTIVITY_RECOGNITION` | Required for health foreground service type |
| `VIBRATE` | Haptic feedback patterns per state |
| `WAKE_LOCK` | Keep CPU awake during emergency trigger |
| `RECEIVE_BOOT_COMPLETED` | Auto-start fall detection on boot |
| `POST_NOTIFICATIONS` | Notification channel alerts (API 33+) |
| `USE_FULL_SCREEN_INTENT` | Full-screen emergency alert on lock screen |
| `INTERNET` | WebView map + OpenAI API calls |

---

## Accessibility

The app is designed with accessibility as a core principle, not an afterthought.

### Multimodal Interaction (5 modalities)

| Modality | Implementation |
|---|---|
| **Accelerometer (sensor)** | Fall detection + tremor detection -- no user action needed |
| **Touch (motor)** | 100-120dp buttons, full-width, per-state colour coding |
| **Voice Input (audio)** | SpeechRecognizer keyword matching per state ("help", "fire", "confirm") |
| **Voice Output (audio)** | TextToSpeech reads every state change and all options aloud |
| **Haptics (tactile)** | Distinct VibrationEffect patterns per state |

### Screen Reader Support (TalkBack)

- All interactive elements have `contentDescription` attributes.
- Dynamic buttons update `contentDescription` programmatically as labels change per state.
- Decorative elements use `importantForAccessibility="no"`.

### Adaptive Communication

Users choose their preferred interaction mode during onboarding:
- **Touch** -- buttons only, no voice activation
- **Voice** -- full STT + TTS
- **Both** -- all modalities active simultaneously

### Motor Accessibility

- Minimum button height: 100dp (primary), 88dp (secondary), 72dp (cancel)
- Full-width buttons (`match_parent`) -- no precision targeting required
- Volume keys as alternative emergency trigger
- Auto-escalation: if the user does not respond during countdown, emergency services are contacted automatically

### Bystander Accessibility

- AI-generated help cards in 4 languages (English, Malay, Chinese, Tamil)
- Text-to-Speech reads cards aloud with adjusted pitch/rate for noisy environments
- High-contrast colour-coded card grid
- Haptic confirmation on card interaction

---

## SMS Format (SCDF Guidelines)

The app formats SMS per [SCDF Emergency SMS guidelines](https://www.scdf.gov.sg/home/about-scdf/emergency-medical-services):

- **Fire**: `Fire Engine. Blk 889 Tampines St 81, #05-123. {Name}'s unit is on fire.`
- **Ambulance**: `Ambulance. Blk 889 Tampines St 81, #05-123. {Name} has fallen and needs help.`

Caregiver SMS includes the SCDF message plus a Google Maps location link.

---

## Tech Stack

| Component | Technology |
|---|---|
| Language | Kotlin |
| Min SDK | 26 (Android 8.0) |
| Target SDK | 34 (Android 14) |
| UI | Material Design 3 (Material Components) |
| Architecture | MVVM with StateFlow |
| Location | Google Play Services FusedLocationProviderClient |
| Voice | Android SpeechRecognizer + TextToSpeech |
| SMS | Android SmsManager |
| Storage | SharedPreferences |
| AI | OpenAI GPT-4o-mini (for bystander cards) |
| Map | Google Maps Embed (WebView iframe) |
| Build | Gradle 8.x with Kotlin DSL |
| JDK | 17 |

---

## Testing

See [docs/testing-guide.md](docs/testing-guide.md) and [docs/test-summary.md](docs/test-summary.md) for comprehensive test documentation.

### Quick Test Commands

```bash
# Run unit tests
cd app
./gradlew test

# Run instrumented tests (requires device)
./gradlew connectedAndroidTest

# Simulate fall detection via ADB
adb shell am broadcast -a com.example.emergencyresponse.ACTION_FALL_DETECTED --es trigger_type fall -p com.example.emergencyresponse
```

### Test Coverage

- 29 tests covering fall detection, tremor detection, false positive prevention, and service lifecycle.
- See [docs/test-summary.md](docs/test-summary.md) for details.

---

## Troubleshooting

| Issue | Solution |
|---|---|
| **R.jar file lock (Windows/OneDrive)** | Close Android Studio, delete `app/build/`, reopen. Known OneDrive file-locking issue. |
| **Battery optimization** | Whitelist the app in manufacturer battery settings. Check Logcat for OEM guidance. |
| **Voice commands not working** | Ensure microphone permission is granted and communication mode includes Voice. |
| **Location not resolving** | Ensure device GPS is enabled. The app prompts to open location settings if off. |
| **Bystander cards showing fallback only** | Check `gradle.properties` has a valid `OPENAI_API_KEY`. Filter Logcat by `OpenAiService` for diagnostics. |
| **Gradle sync fails** | Ensure you opened the `app/` folder (not the repo root) as the Gradle project in Android Studio. |

---

## Documentation

| Document | Description |
|---|---|
| [README.md](README.md) | This file -- overview, setup, features |
| [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md) | Architecture, design decisions, data flow |
| [docs/run-native-android.md](docs/run-native-android.md) | Detailed step-by-step run guide |
| [docs/testing-guide.md](docs/testing-guide.md) | Testing guide for FallDetectionService |
| [docs/test-summary.md](docs/test-summary.md) | Test coverage summary |

---

## License

This project was built for the Beyond Binary Hackathon 2026.
